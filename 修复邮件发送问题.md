# 修复邮件发送问题

## 问题诊断

根据 Netlify 日志，邮件只是"准备"了，但没有实际发送。日志显示：
```
Email notification prepared: { ... }
```

这说明 **`RESEND_API_KEY` 环境变量没有设置或没有生效**。

---

## 解决步骤

### 步骤 1：检查 Netlify 环境变量

1. 登录 Netlify：https://app.netlify.com
2. 进入你的站点
3. 点击 **Site configuration** → **Environment variables**

### 步骤 2：添加或检查 `RESEND_API_KEY`

#### 如果还没有这个变量：

1. 点击 **Add a variable**（添加变量）
2. **Key**：`RESEND_API_KEY`
3. **Value**：粘贴你的 Resend API Key（格式：`re_xxxx...`）
   - 获取方式：登录 [Resend](https://resend.com) → **API Keys** → 复制你的 Key
4. **Scopes**（作用域）：
   - 选择 **All scopes**（所有环境）或
   - 至少选择 **Production**（生产环境）
5. 点击 **Save**（保存）

#### 如果已经有这个变量：

1. 检查 **Value** 是否正确（必须以 `re_` 开头）
2. 检查 **Scopes** 是否包含 **Production**
3. 如果有问题，点击变量右侧的 **Edit**（编辑）修改

### 步骤 3：添加或检查 `RESEND_FROM`（如果还没有）

1. 点击 **Add a variable**
2. **Key**：`RESEND_FROM`
3. **Value**：`Electrical Inspection <reports@bhtechnology.com.au>`
   - 注意：`reports@bhtechnology.com.au` 必须是你在 Resend 已验证的域名下的地址
4. **Scopes**：选择 **All scopes** 或 **Production**
5. 点击 **Save**

### 步骤 4：重新部署（重要！）

**环境变量修改后，必须重新部署才能生效！**

1. 在 Netlify 站点页面，点击顶部菜单 **Deploys**（部署）
2. 点击右上角的 **Trigger deploy**（触发部署）
3. 选择 **Deploy site**（部署站点）
4. 等待部署完成（状态变为 **Published**，通常 1-3 分钟）

### 步骤 5：再次测试

1. 提交一条新的测试检查
2. 查看 Netlify Functions 日志（**Functions** → **submitInspection** → **Logs**）

**成功的情况**，应该看到：
```
Email sent via Resend: eml_xxxxx...
```

**如果还是失败**，日志会显示具体错误，例如：
- `Invalid API key` → API Key 错误，检查是否复制完整
- `Invalid from address` → 发件地址格式错误或域名未验证

---

## 检查清单

在重新部署前，确认：

- [ ] `RESEND_API_KEY` 已设置，值为 `re_xxxx...`（没有多余空格）
- [ ] `RESEND_API_KEY` 的作用域包含 **Production**
- [ ] `RESEND_FROM` 已设置，格式为 `Electrical Inspection <reports@bhtechnology.com.au>`
- [ ] `RESEND_FROM` 中的邮箱地址使用的域名已在 Resend 验证通过
- [ ] 已点击 **Trigger deploy** → **Deploy site** 重新部署
- [ ] 部署状态已变为 **Published**

---

## 常见问题

### Q: 我设置了环境变量，但日志还是显示 "Email notification prepared"

**A:** 可能的原因：
1. **没有重新部署** - 环境变量修改后必须重新部署
2. **作用域不对** - 确保选择了 **Production** 或 **All scopes**
3. **变量名拼写错误** - 必须是 `RESEND_API_KEY`（全大写，下划线）

### Q: 重新部署后还是不行

**A:** 检查：
1. 在 Netlify 环境变量页面，确认变量确实存在且值正确
2. 查看最新的部署日志，确认没有错误
3. 查看 Functions 日志，看是否有新的错误信息

### Q: 如何确认 API Key 是否正确？

**A:** 
1. 登录 [Resend](https://resend.com) → **API Keys**
2. 确认 Key 状态为 **Active**（活跃）
3. 如果 Key 被删除或禁用，需要创建新的

---

## 完成后的验证

设置完成并重新部署后，提交一条测试检查，日志应该显示：

```
✅ Email sent via Resend: eml_xxxxx...
```

然后检查 `info@bhtechnology.com.au` 邮箱（包括垃圾邮件文件夹），应该能收到邮件。
