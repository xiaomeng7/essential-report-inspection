# 新功能使用指南

## 📋 目录
1. [邮件改进 - Complete Inspection Data 表格显示](#1-邮件改进)
2. [规则管理页面 - 编辑判断规则和权重](#2-规则管理页面)
3. [修复 view full report 404 错误](#3-修复-404-错误)

---

## 1. 邮件改进 - Complete Inspection Data 表格显示

### ✅ 已自动完成
邮件中的 "Complete Inspection Data" 现在会自动以表格形式显示，不再显示 JSON。

### 如何测试
1. 提交一个新的检查报告
2. 检查邮箱 `info@bhtechnology.com.au`
3. 在邮件中查看 "Complete Inspection Data" 部分
4. 应该看到：
   - 按章节分组的表格
   - 清晰的字段名和值
   - 布尔值显示为 "Yes"/"No"
   - 数组格式化显示

---

## 2. 规则管理页面 - 编辑判断规则和权重

### 步骤 1: 设置管理员 Token

#### 在 Netlify 中设置环境变量：

1. 登录 Netlify Dashboard
2. 进入你的网站项目
3. 点击 **Site settings** → **Environment variables**
4. 点击 **Add a variable**
5. 添加：
   - **Key**: `ADMIN_TOKEN`
   - **Value**: 设置一个安全的密码（例如：`my-secret-admin-token-2024`）
6. 点击 **Save**

#### 或者使用 Netlify CLI：

```bash
netlify env:set ADMIN_TOKEN "my-secret-admin-token-2024"
```

### 步骤 2: 部署代码

确保最新的代码已部署到 Netlify：

```bash
# 如果使用 Git 部署，提交并推送
git add .
git commit -m "Add rules admin and email improvements"
git push

# Netlify 会自动部署
```

或者手动部署：

```bash
npm run build
netlify deploy --prod
```

### 步骤 3: 访问规则管理页面

1. 打开浏览器，访问你的网站
2. 在地址栏输入：`https://你的网站域名/admin/rules`
   - 例如：`https://inspeti.netlify.app/admin/rules`
3. 首次访问会弹出提示框，输入你设置的 `ADMIN_TOKEN`
4. Token 会保存在浏览器 localStorage 中，下次访问不需要再输入

### 步骤 4: 使用规则管理页面

#### 查看规则结构
- 页面顶部显示所有 Findings 及其权重（Safety, Urgency, Liability）
- 显示 Hard Overrides（强制覆盖的规则）
- 显示 Priority Matrix（优先级矩阵）

#### 编辑规则

1. **查看 YAML 编辑器**
   - 页面下方有完整的 YAML 编辑器
   - 显示当前的 `rules.yml` 内容

2. **修改规则**
   - 直接在编辑器中修改 YAML
   - 例如，修改某个 finding 的权重：
     ```yaml
     findings:
       MEN_NOT_VERIFIED: { safety: HIGH, urgency: IMMEDIATE, liability: HIGH }
       # 改为
       MEN_NOT_VERIFIED: { safety: MODERATE, urgency: SHORT_TERM, liability: MEDIUM }
     ```

3. **格式化 YAML**
   - 点击 **"Format YAML"** 按钮自动格式化代码
   - 确保缩进和格式正确

4. **保存规则**
   - 点击 **"Save Rules"** 按钮
   - 等待保存成功提示
   - 新规则会立即生效（缓存已清除）

### 步骤 5: 验证规则更改

1. 提交一个新的测试检查报告
2. 查看生成的 findings 是否符合新规则
3. 如果规则没有生效，等待几秒钟后重试（缓存清除需要时间）

---

## 3. 修复 view full report 404 错误

### ✅ 已自动完成
修复了邮件中 "View Full Report" 链接的 404 错误。

### 如何验证

1. 提交一个检查报告
2. 在邮件中点击 **"View Full Report"** 按钮
3. 应该能正常打开报告页面，而不是 404 错误

### 如果仍然出现 404

检查以下几点：

1. **确认路由配置**
   - 检查 `netlify.toml` 中是否有 `/review/*` 的重定向规则
   - 应该包含：
     ```toml
     [[redirects]]
       from = "/review/*"
       to = "/index.html"
       status = 200
     ```

2. **检查报告 ID**
   - 确认邮件中的 URL 格式正确
   - 应该是：`https://你的域名/review/EH-2024-XXXX`

3. **检查数据存储**
   - 报告数据存储在内存中（使用 `store.ts`）
   - 如果 Netlify Function 重启，数据会丢失
   - 这是正常行为（当前实现）

---

## 🔧 故障排除

### 规则管理页面无法访问

**问题**: 访问 `/admin/rules` 显示 404 或空白页

**解决方案**:
1. 确认代码已部署
2. 检查 `netlify.toml` 中是否有 `/admin/*` 重定向：
   ```toml
   [[redirects]]
     from = "/admin/*"
     to = "/index.html"
     status = 200
   ```
3. 清除浏览器缓存并刷新

### Token 认证失败

**问题**: 提示 "Unauthorized - Invalid token"

**解决方案**:
1. 确认 Netlify 环境变量 `ADMIN_TOKEN` 已设置
2. 清除浏览器 localStorage：
   - 打开浏览器开发者工具（F12）
   - 进入 Application/Storage → Local Storage
   - 删除 `admin_token`
   - 刷新页面，重新输入 token

### 规则保存失败

**问题**: 点击 "Save Rules" 后显示错误

**可能原因**:
1. YAML 格式错误
   - 点击 "Format YAML" 自动格式化
   - 检查缩进（使用 2 个空格）
   - 检查语法错误

2. 文件系统权限问题
   - Netlify Functions 的文件系统可能是只读的
   - 如果保存失败，可能需要使用数据库或版本控制来存储规则

### 邮件中的表格显示异常

**问题**: 邮件中仍然显示 JSON 或表格格式不正确

**解决方案**:
1. 确认 `email.ts` 文件已更新
2. 重新部署代码
3. 提交新的测试报告
4. 检查邮件客户端是否支持 HTML 表格（大多数现代邮件客户端都支持）

---

## 📝 规则编辑示例

### 示例 1: 修改 Finding 的优先级

**修改前**:
```yaml
findings:
  MEN_NOT_VERIFIED: { safety: HIGH, urgency: IMMEDIATE, liability: HIGH }
```

**修改后**:
```yaml
findings:
  MEN_NOT_VERIFIED: { safety: MODERATE, urgency: SHORT_TERM, liability: MEDIUM }
```

### 示例 2: 添加新的 Finding

```yaml
findings:
  # ... 现有 findings ...
  NEW_FINDING_CODE: { safety: LOW, urgency: LONG_TERM, liability: LOW }
```

### 示例 3: 修改 Priority Matrix

```yaml
base_priority_matrix:
  - when:
      safety: HIGH
    then: IMMEDIATE
  # 添加新规则
  - when:
      safety: MODERATE
      urgency: IMMEDIATE
    then: IMMEDIATE
```

---

## 🎯 快速检查清单

- [ ] 在 Netlify 中设置了 `ADMIN_TOKEN` 环境变量
- [ ] 代码已部署到 Netlify
- [ ] 可以访问 `/admin/rules` 页面
- [ ] 可以成功登录（输入 token）
- [ ] 可以查看规则结构
- [ ] 可以编辑 YAML
- [ ] 可以保存规则
- [ ] 邮件中的表格显示正常
- [ ] "View Full Report" 链接正常工作

---

## 💡 提示

1. **备份规则**: 在修改规则前，建议先复制当前的 YAML 内容作为备份
2. **测试规则**: 修改规则后，提交一个测试报告验证效果
3. **版本控制**: 考虑将 `rules.yml` 纳入 Git 版本控制，方便追踪更改
4. **定期检查**: 定期检查规则是否符合业务需求

---

## 📞 需要帮助？

如果遇到问题：
1. 检查 Netlify Functions 日志：Netlify Dashboard → Functions → Logs
2. 检查浏览器控制台：F12 → Console
3. 确认所有环境变量已正确设置
