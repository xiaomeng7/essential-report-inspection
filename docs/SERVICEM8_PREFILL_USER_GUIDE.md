## ServiceM8 预填功能使用说明（给现场检测员）

### 1. 功能目的

- **减少手工录入**：当你在现场只有 ServiceM8 的工作单编号（Job / Work Number）时，可一键从 ServiceM8 拉取客户名称、联系人和联系方式。
- **避免抄错信息**：客户名称、联系人、电话、邮箱直接从 ServiceM8 同步，减少听写/手抄错误。
- **地址自动填入**：若 ServiceM8 中已有地址，系统会通过 Geocoding 转换为规范地址并自动填入 Property address；若未自动填入，则需在表单中手动选择。

### 2. 入口位置

1. 打开检测系统首页 `/`，看到 **Start Screen**。
2. 在说明卡片和 Workflow 之间，有一块卡片标题为：
   - `ServiceM8 预填（可选）`

这块区域完全是**可选项**，如果当班没有用 ServiceM8，也可以跳过，直接点击 **Start / Continue** 进入表单。

### 3. 使用步骤

#### 3.1 有 ServiceM8 工作编号时

1. 在手机或平板上打开 ServiceM8，找到当前任务的 **Job / Work Number**（通常在工作详情页面顶部可见）。
2. 在检测系统的 `ServiceM8 预填（可选）` 区域：
   - 在输入框中输入该 Job / Work Number（如 `JOB1234`）。
   - 点击右侧按钮 **“Fetch details”**。
3. 正常情况下，稍等 1–2 秒，下面会出现一块灰色的摘要卡片，显示：
   - **Customer / 委托方**：ServiceM8 中的客户名称（会自动写入报告里的 `Prepared for / CLIENT_NAME` 字段）。
   - **Contact**：联系人姓名（如果有）。
   - **Phone / Email**：联系电话和邮箱（如果有）。
   - **Address (ServiceM8)**：在 ServiceM8 里记录的地址字符串，仅供参考。
   - 一行小字：  
     `Data source: ServiceM8 (缓存命中/实时查询) · 2026-02-03 14:23`

4. 这一步完成后，系统会自动：
   - 将 **客户名称** 写入内部字段 `job.prepared_for`。
   - 将 **工作编号** 写入 `job.serviceM8_job_number`，用于后台在数据库中建立「检查记录 ↔ ServiceM8 工作单」的关联。
   - 若 ServiceM8 中有地址，会通过 Geocoding 自动填入 **Property address**（需配置 GOOGLE_MAPS_API_KEY）。

#### 3.2 继续常规表单

1. 点击 **Start / Continue** 进入第一个表单页面（`Start / Context`）。
2. 在该页面中你会看到：
   - “委托方 / Prepared for” 已经自动填上了刚才从 ServiceM8 读取的客户名（可按需要手动修改）。
   - “Property address” 若预填成功，地址已自动填入；若未自动填入，则需手动选择。
3. 若地址未自动填入，在 **Property address** 字段中：
   - 在地址输入框中开始键入地址（例如：“123 Example St”）。
   - 从下拉建议中**选择**正确的地址。
   - 等待系统自动补全 suburb / state / postcode。
4. 后续所有步骤（室内房间、配电盘 & RCD、屋顶空间、外部与收尾）按照原先培训说明执行，无需额外操作。

### 4. 常见错误与处理

#### 4.1 找不到工作编号

- 现象：点击 **Fetch details** 后，卡片下方出现红色提示：
  - `未在 ServiceM8 中找到该工作编号。`
- 处理办法：
  - 确认自己抄写的 Job / Work Number 是否正确（注意大小写、前后空格）。
  - 如果仍提示找不到，可以直接**忽略 ServiceM8 预填**，手动填写委托方和地址。

#### 4.2 ServiceM8 集成未配置（多见于测试环境）

- 现象：出现类似提示：
  - `ServiceM8 集成未配置，请在 Netlify 环境中设置相关密钥后重试。`
- 处理办法：
  - 这是后台配置问题，与现场操作无关。
  - 这种情况下，你可以直接跳过 ServiceM8 预填，手工填写委托方和地址。

#### 4.3 授权失败（前端密钥不匹配）

- 现象：出现提示：
  - `预填接口未授权，请检查前端密钥配置。`
- 处理办法：
  - 通知技术负责人或开发同事，这是前端与后端的密钥配置不一致导致的。
  - 在问题修复前，可暂时不使用 ServiceM8 预填，改为手工录入。

### 5. 注意事项与最佳实践

- **地址自动填入**：
  - 若 ServiceM8 中有地址，系统会尝试通过 Google Geocoding 转换为规范地址并自动填入 Property address。
  - 若 Geocoding 失败或 ServiceM8 中无地址，仍需在表单中通过地址搜索选择，以确保 suburb/state/postcode 正确。
- **委托方名称可以微调**：
  - 如果 ServiceM8 中的客户名太长或不适合作为报告抬头，比如包含内部备注（如 “张三 – 2026年2月巡检”），可以在表单里的 “Prepared for” 上做适度简化。
- **多个设备/浏览器的一致性**：
  - ServiceM8 预填只在你当前打开的浏览器会话中生效。
  - 若更换设备重新打开检查链接，需要重新执行一次 ServiceM8 预填或手动核对客户信息。

### 6. 发生问题时如何反馈

如果在现场使用 ServiceM8 预填时遇到下列情况：

- 明明有该工作单，但系统一直提示 `JOB_NOT_FOUND`。
- 预填信息明显与 ServiceM8 内的客户不匹配。
- 点击 Fetch 之后页面长时间无响应或报错。

请尽量截图并记录：

1. ServiceM8 应用中该工作单的详情页面（包含 Job / Work Number）。
2. 检测系统中的 Start Screen 界面（含输入的 Job Number 和错误提示）。
3. 如果方便，请提供大致时间点（精确到分钟即可），方便后台在日志中定位。

将以上信息发给技术负责人或开发同事，他们可以通过后台日志和数据库记录进一步排查问题原因。  

