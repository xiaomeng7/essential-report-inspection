# 查看邮件发送日志步骤

## 当前情况

- ✅ Netlify API 请求成功（200 OK）
- ❌ Resend Dashboard 没有发送记录
- ❌ 说明邮件没有发送到 Resend

---

## 步骤 1：查看 Netlify Functions 日志

### 1.1 进入日志页面

1. 登录 Netlify：https://app.netlify.com
2. 进入你的站点（`inspetionreport`）
3. 点击顶部菜单 **Functions**（函数）
4. 找到 **submitInspection**，点击进入
5. 点击 **Logs**（日志）标签

### 1.2 查找最近的日志

找到时间 **10:05:06 AM**（或接近这个时间）的日志，查找以下关键信息：

#### 关键日志 1：环境变量检查

应该看到类似这样的日志：
```
Email sending - Environment check: {
  hasApiKey: true/false,  ← 这里！
  apiKeyPrefix: "re_12..." 或 "none",  ← 这里！
  from: "...",
  recipient: "info@bhtechnology.com.au"
}
```

**如果 `hasApiKey: false`**：
- ❌ 说明 `RESEND_API_KEY` 环境变量还是没有读取到
- 需要检查 Netlify 环境变量设置

**如果 `hasApiKey: true`**：
- ✅ 环境变量存在
- 继续看下面的日志

#### 关键日志 2：发送尝试

如果 `hasApiKey: true`，应该看到：
```
Attempting to send email via Resend...
```

然后要么：
- ✅ **成功**：`Email sent via Resend successfully: { emailId: "eml_xxxxx...", ... }`
- ❌ **失败**：`Resend send error: { ... }` 或 `Failed to send email (non-blocking): { ... }`

---

## 步骤 2：根据日志结果处理

### 情况 A：`hasApiKey: false`

**问题**：环境变量没有读取到

**解决方法**：

1. **检查环境变量是否存在**：
   - Netlify → **Site configuration** → **Environment variables**
   - 确认 `RESEND_API_KEY` 存在

2. **检查作用域**：
   - 点击 `RESEND_API_KEY` 查看详情
   - 确认 **Scopes** 包含 **Production** 或 **All scopes**
   - 如果只有 **Development**，需要修改

3. **重新部署**：
   - 修改环境变量后，必须重新部署
   - **Deploys** → **Trigger deploy** → **Deploy site**

### 情况 B：`hasApiKey: true` 但发送失败

**问题**：环境变量存在，但发送出错

**查看错误信息**：
- 日志中会显示 `Resend send error:` 或 `Failed to send email:`
- 把完整的错误信息发给我

**常见错误**：
- `Invalid API key` → API Key 错误
- `Invalid from address` → 发件地址格式错误或域名未验证
- `Rate limit exceeded` → 发送频率过高

### 情况 C：没有看到新的详细日志

**问题**：代码可能还没更新

**解决方法**：

1. **确认代码已推送**：
   ```bash
   cd /Users/mengzhang/Downloads/essential_report_specs
   git log --oneline -5
   ```
   应该看到 "Add detailed email logging" 这个 commit

2. **确认 Netlify 已部署最新代码**：
   - Netlify → **Deploys**
   - 查看最新部署的时间
   - 如果部署时间早于代码提交时间，需要重新部署

3. **手动触发部署**：
   - **Deploys** → **Trigger deploy** → **Deploy site**

---

## 步骤 3：如果还是不行

### 3.1 检查环境变量（再次确认）

在 Netlify 环境变量页面：

- [ ] `RESEND_API_KEY` 存在，值为 `re_xxxx...`（没有多余空格）
- [ ] `RESEND_API_KEY` 的作用域包含 **Production**
- [ ] `RESEND_FROM` 存在，格式为 `Electrical Inspection <reports@bhtechnology.com.au>`
- [ ] `RESEND_FROM` 的作用域包含 **Production**

### 3.2 测试环境变量读取

可以创建一个简单的测试 Function 来验证环境变量是否能被读取。

---

## 请把日志发给我

请把 **Netlify Functions → submitInspection → Logs** 中，时间 **10:05:06 AM** 附近的完整日志发给我，特别是：

1. `Email sending - Environment check:` 这一行
2. 如果有错误，`Resend send error:` 或 `Failed to send email:` 的完整内容

这样我可以帮你准确定位问题。
