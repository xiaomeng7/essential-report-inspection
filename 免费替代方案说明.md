# å…è´¹æ›¿ä»£æ–¹æ¡ˆè¯´æ˜

## ğŸ“¦ å·²å®‰è£…çš„ä¾èµ–

âœ… **å·²å®‰è£…çš„å…è´¹ä¾èµ–ï¼š**
- `docxtemplater` (^3.67.6) - Word æ¨¡æ¿å¼•æ“
- `pizzip` (^3.2.0) - ZIP/DOCX æ–‡ä»¶å¤„ç†
- `markdown-it` (^14.1.0) - Markdown è½¬ HTML
- `html-docx-js-typescript` (^0.1.5) - HTML è½¬ DOCXï¼ˆå…è´¹ï¼‰
- `docx-merger` (^1.2.2) - åˆå¹¶å¤šä¸ª DOCX æ–‡ä»¶

âŒ **æœªå®‰è£…çš„ä»˜è´¹æ¨¡å—ï¼š**
- `docxtemplater-html-module` - éœ€è¦è´­ä¹°ï¼ˆhttps://docxtemplater.com/shop/modules/?preselect=htmlï¼‰

## ğŸ¯ å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šHTML è½¬ DOCX å¹¶åˆå¹¶ï¼ˆæ¨èï¼Œä¿ç•™æ ¼å¼ï¼‰

**æ–‡ä»¶ï¼š** `netlify/functions/lib/renderDocx.ts`

**å·¥ä½œåŸç†ï¼š**
1. ä½¿ç”¨ `docxtemplater` å¡«å……å°é¢ä¿¡æ¯ï¼ˆ6ä¸ªå­—æ®µï¼‰
2. ä½¿ç”¨ `html-docx-js-typescript` å°† HTML è½¬æ¢ä¸ºå®Œæ•´çš„ DOCX æ–‡ä»¶
3. ä½¿ç”¨ `docx-merger` åˆå¹¶å°é¢ DOCX å’Œæ­£æ–‡ DOCX

**ä¼˜ç‚¹ï¼š**
- âœ… ä¿ç•™ HTML æ ¼å¼ï¼ˆç²—ä½“ã€åˆ—è¡¨ã€è¡¨æ ¼ç­‰ï¼‰
- âœ… å®Œå…¨å…è´¹
- âœ… æ”¯æŒå¤æ‚æ ¼å¼

**ç¼ºç‚¹ï¼š**
- âš ï¸ éœ€è¦åˆå¹¶ä¸¤ä¸ª DOCX æ–‡ä»¶
- âš ï¸ å¯èƒ½åœ¨æŸäº› Word ç‰ˆæœ¬ä¸­æ˜¾ç¤ºè­¦å‘Šï¼ˆaltChunk å…¼å®¹æ€§ï¼‰

**ä½¿ç”¨ï¼š**
```typescript
import { renderDocxWithHtmlMerge } from "./lib/renderDocx";

const result = await renderDocxWithHtmlMerge(templateBuffer, {
  INSPECTION_ID: "...",
  ASSESSMENT_DATE: "...",
  // ... å…¶ä»–å°é¢å­—æ®µ
  REPORT_BODY_HTML: "<h1>æŠ¥å‘Šå†…å®¹</h1><p>æ­£æ–‡...</p>"
});
```

### æ–¹æ¡ˆ Bï¼šHTML è½¬çº¯æ–‡æœ¬æ’å…¥ï¼ˆç®€å•ä½†ä¸¢å¤±æ ¼å¼ï¼‰

**æ–‡ä»¶ï¼š** `netlify/functions/lib/renderDocx.ts`

**å·¥ä½œåŸç†ï¼š**
1. ä½¿ç”¨ `docxtemplater` å¡«å……å°é¢ä¿¡æ¯
2. å°† HTML è½¬æ¢ä¸ºæ ¼å¼åŒ–çš„çº¯æ–‡æœ¬
3. ç›´æ¥æ’å…¥åˆ°æ¨¡æ¿çš„ `{{REPORT_BODY_HTML}}` å ä½ç¬¦

**ä¼˜ç‚¹ï¼š**
- âœ… ç®€å•ç›´æ¥
- âœ… ä¸éœ€è¦åˆå¹¶æ–‡ä»¶
- âœ… å®Œå…¨å…¼å®¹æ‰€æœ‰ Word ç‰ˆæœ¬

**ç¼ºç‚¹ï¼š**
- âŒ ä¸¢å¤±æ‰€æœ‰ HTML æ ¼å¼ï¼ˆç²—ä½“ã€åˆ—è¡¨ã€è¡¨æ ¼ç­‰ï¼‰
- âŒ åªä¿ç•™æ®µè½ç»“æ„å’Œæ¢è¡Œ

**ä½¿ç”¨ï¼š**
```typescript
import { renderDocxWithHtmlAsText } from "./lib/renderDocx";

const result = renderDocxWithHtmlAsText(templateBuffer, {
  INSPECTION_ID: "...",
  // ... å…¶ä»–å­—æ®µ
  REPORT_BODY_HTML: "<h1>æŠ¥å‘Šå†…å®¹</h1>"
});
```

### ä¸»å‡½æ•°ï¼ˆè‡ªåŠ¨é€‰æ‹©æ–¹æ¡ˆï¼‰

**æ–‡ä»¶ï¼š** `netlify/functions/lib/renderDocx.ts`

```typescript
import { renderDocx } from "./lib/renderDocx";

// è‡ªåŠ¨ä½¿ç”¨æ–¹æ¡ˆ Aï¼Œå¤±è´¥æ—¶å›é€€åˆ°æ–¹æ¡ˆ B
const result = await renderDocx(templateBuffer, data);
```

## ğŸ“ Markdown è½¬ HTML

**æ–‡ä»¶ï¼š** `netlify/functions/lib/markdownToHtml.ts`

```typescript
import { markdownToHtml } from "./lib/markdownToHtml";

const markdown = "# æ ‡é¢˜\n\n**ç²—ä½“** æ–‡æœ¬";
const html = markdownToHtml(markdown);
// è¿”å›: "<h1>æ ‡é¢˜</h1>\n<p><strong>ç²—ä½“</strong> æ–‡æœ¬</p>\n"
```

**æ”¯æŒçš„ Markdown è¯­æ³•ï¼š**
- æ ‡é¢˜ï¼ˆ# ## ###ï¼‰
- åˆ—è¡¨ï¼ˆ- * 1.ï¼‰
- è¡¨æ ¼
- ç²—ä½“ã€æ–œä½“
- é“¾æ¥
- æ¢è¡Œ

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

```typescript
// 1. ç”Ÿæˆ Markdown
const markdown = buildReportMarkdown({ inspection, findings, responses, computed });

// 2. è½¬æ¢ä¸º HTML
const html = markdownToHtml(markdown);

// 3. è¯»å– Word æ¨¡æ¿
const templateBuffer = fs.readFileSync("report-template.docx");

// 4. å‡†å¤‡æ•°æ®
const data = {
  INSPECTION_ID: "...",
  ASSESSMENT_DATE: "...",
  PREPARED_FOR: "...",
  PREPARED_BY: "...",
  PROPERTY_ADDRESS: "...",
  PROPERTY_TYPE: "...",
  REPORT_BODY_HTML: html
};

// 5. ç”Ÿæˆ Word æ–‡æ¡£
const docxBuffer = await renderDocx(templateBuffer, data);

// 6. ä¿å­˜æˆ–è¿”å›
fs.writeFileSync("output.docx", docxBuffer);
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ¨¡æ¿è¦æ±‚ï¼š**
   - å°é¢éƒ¨åˆ†ï¼šåŒ…å« 6 ä¸ªå ä½ç¬¦ï¼ˆ`{{INSPECTION_ID}}` ç­‰ï¼‰
   - æ­£æ–‡éƒ¨åˆ†ï¼šåŒ…å« `{{REPORT_BODY_HTML}}` å ä½ç¬¦ï¼ˆå¦‚æœä½¿ç”¨æ–¹æ¡ˆ Bï¼‰

2. **æ–¹æ¡ˆ A çš„é™åˆ¶ï¼š**
   - `html-docx-js-typescript` ä½¿ç”¨ altChunk æŠ€æœ¯
   - æŸäº› Word ç‰ˆæœ¬ï¼ˆå¦‚ Mac 2008ï¼‰å¯èƒ½ä¸æ”¯æŒ
   - LibreOffice å’Œ Google Docs ä¸æ”¯æŒ

3. **æ–¹æ¡ˆ B çš„é™åˆ¶ï¼š**
   - ä¼šä¸¢å¤±æ‰€æœ‰ HTML æ ¼å¼
   - åªé€‚åˆç®€å•æ–‡æœ¬å†…å®¹

## ğŸš€ ä¸‹ä¸€æ­¥

æ ¹æ®ä½ çš„éœ€æ±‚é€‰æ‹©æ–¹æ¡ˆï¼š
- **éœ€è¦ä¿ç•™æ ¼å¼**ï¼šä½¿ç”¨æ–¹æ¡ˆ Aï¼ˆ`renderDocxWithHtmlMerge`ï¼‰
- **ç®€å•å¿«é€Ÿ**ï¼šä½¿ç”¨æ–¹æ¡ˆ Bï¼ˆ`renderDocxWithHtmlAsText`ï¼‰
- **è‡ªåŠ¨é€‰æ‹©**ï¼šä½¿ç”¨ä¸»å‡½æ•° `renderDocx`ï¼ˆæ¨èï¼‰

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `netlify/functions/lib/renderDocx.ts` - DOCX æ¸²æŸ“å®ç°
- `netlify/functions/lib/markdownToHtml.ts` - Markdown è½¬ HTML
- `CURSOR_PROMPTS_STEP_BY_STEP.md` - å®Œæ•´å®æ–½æ­¥éª¤
